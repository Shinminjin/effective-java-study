# Item 48 - ìŠ¤íŠ¸ë¦¼ ë³‘ë ¬í™”ëŠ” ì£¼ì˜í•´ì„œ ì ìš©í•˜ë¼

## **ìë°”ì™€ ë™ì‹œì„± í”„ë¡œê·¸ë˜ë°**

ë™ì‹œì„± í”„ë¡œê·¸ë˜ë° ì¸¡ë©´ì—ì„œ ìë°”ëŠ” í•­ìƒ ì•ì„œê°”ë‹¤.

- ìŠ¤ë ˆë“œ, ë™ê¸°í™”, wait/notify - *ì²˜ìŒ ë¦´ë¦¬ì¦ˆë¶€í„° ì§€ì›*
- ë™ì‹œì„± ì»¬ë ‰ì…˜(`java.util.concurrent`), ì‹¤í–‰ì í”„ë ˆì„ì›Œí¬(`Executor`) - *ìë°” 5ë¶€í„° ì§€ì›*
- ê³ ì„±ëŠ¥ ë³‘ë ¬ ë¶„í•´ í”„ë ˆì„ì›Œí¬(`parallel decom-position`), í¬í¬-ì¡°ì¸ íŒ¨í‚¤ì§€ - *ìë°” 7ë¶€í„° ì§€ì›*
- ë³‘ë ¬ ìŠ¤íŠ¸ë¦¼ ë©”ì„œë“œ(`parallel`) - *ìë°” 8ë¶€í„° ì§€ì›*

ë™ì‹œì„± í”„ë¡œê·¸ë¨ì„ ì‘ì„±í•˜ê¸°ëŠ” ì‰¬ì›Œì§€ê³  ìˆì§€ë§Œ, ì˜¬ë°”ë¥´ê³  ë¹ ë¥´ê²Œ ì‘ì„±í•˜ëŠ” ì¼ì€ ì—¬ì „íˆ ì–´ë µë‹¤.

ë™ì‹œì„± í”„ë¡œê·¸ë˜ë°ì„ í•  ë•ŒëŠ” í•­ìƒ **ì•ˆì •ì„±(safety)**ê³¼ **ì‘ë‹µ ê°€ëŠ¥(liveness) ìƒíƒœ**ë¥¼ ìœ ì§€í•´ì•¼ í•œë‹¤.

ë³‘ë ¬ ìŠ¤íŠ¸ë¦¼ íŒŒì´í”„ë¼ì¸ í”„ë¡œê·¸ë˜ë°ì—ì„œë„ ë§ˆì°¬ê°€ì§€ë‹¤.

## **íŒŒì´í”„ë¼ì¸ ë³‘ë ¬í™”ë¡œ ì„±ëŠ¥ ê°œì„ ì„ ê¸°ëŒ€í•˜ê¸° ì–´ë ¤ìš´ ê²½ìš°**

ìŠ¤íŠ¸ë¦¼ì„ ì‚¬ìš©í•´ ì²˜ìŒ 20ê°œì˜ ë©”ë¥´ì„¼ ì†Œìˆ˜ë¥¼ ìƒì„±í•˜ëŠ” í”„ë¡œê·¸ë¨

```java
public class MersennePrimes {

    @Test
    void MersennePrimesTest() {
        primes().map(p -> TWO.pow(p.intValueExact()).subtract(ONE))
                .filter(mersenne -> mersenne.isProbablePrime(50))
                .limit(20)
                .forEach(System.out::println);
    }

    static Stream<BigInteger> primes() {
        return Stream.iterate(TWO, BigInteger::nextProbablePrime);
    }
}
```
![MersennePrimesTest](image/MersennePrimesTest.png)

- í”„ë¡œê·¸ë¨ ìˆ˜í–‰ ì‹œ, ì•½ 7.5ì´ˆ ê±¸ë ¸ë‹¤.

ì†ë„ë¥¼ ë†’ì´ê³  ì‹¶ì–´ `parallel` ì„ í˜¸ì¶œí•´ ë³‘ë ¬ ì²˜ë¦¬ë¥¼ í•œë‹¤ê³  í•´ë³´ì.

ì´ í”„ë¡œê·¸ë¨ì˜ ì„±ëŠ¥ì€ ì–´ë–»ê²Œ ë³€í• ê¹Œ?

```java
public class MersennePrimes {

    @Test
    void ParallelMersennePrimesTest() {
        primes().map(p -> TWO.pow(p.intValueExact()).subtract(ONE))
                .parallel() // ìŠ¤íŠ¸ë¦¼ ë³‘ë ¬í™”
                .filter(mersenne -> mersenne.isProbablePrime(50))
                .limit(20)
                .forEach(System.out::println);
    }

    static Stream<BigInteger> primes() {
        return Stream.iterate(TWO, BigInteger::nextProbablePrime);
    }
}
```
![ParallelMersennePrimesTest](image/ParallelMersennePrimesTest.png)

- ì•„ë¬´ ê²ƒë„ ì¶œë ¥í•˜ì§€ ëª»í•˜ê³ , ì‘ë‹µ ë¶ˆê°€ ìƒíƒœê°€ ëœë‹¤.
- ìŠ¤íŠ¸ë¦¼ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ íŒŒì´í”„ë¼ì¸ì„ ë³‘ë ¬í™”í•˜ëŠ” ë°©ë²•ì„ ì°¾ì•„ë‚´ì§€ ëª»í–ˆê¸° ë•Œë¬¸ì´ë‹¤.
- **ë°ì´í„° ì†ŒìŠ¤ê°€ Stream.iterateê±°ë‚˜ ì¤‘ê°„ ì—°ì‚°ìœ¼ë¡œ limitë¥¼ ì“°ë©´ íŒŒì´í”„ë¼ì¸ ë³‘ë ¬í™”ë¡œëŠ” ì„±ëŠ¥ ê°œì„ ì„ ê¸°ëŒ€í•  ìˆ˜ ì—†ë‹¤.**

ì¦‰, ìŠ¤íŠ¸ë¦¼ íŒŒì´í”„ë¼ì¸ì„ ë§ˆêµ¬ì¡ì´ë¡œ ë³‘ë ¬í™”í•˜ë©´ ì˜¤íˆë ¤ ì„±ëŠ¥ì´ ë‚˜ë¹ ì§ˆ ìˆ˜ ìˆë‹¤.

## **ìŠ¤íŠ¸ë¦¼ ë³‘ë ¬í™”ëŠ” ì–´ë–¤ ê²½ìš° ì‚¬ìš©í•´ì•¼ í• ê¹Œâ“**

### **âœ”ï¸ ë³‘ë ¬í™” íš¨ê³¼ê°€ ì¢‹ì€ ìŠ¤íŠ¸ë¦¼ ì†ŒìŠ¤**

- `ArrayList`, `HashMap`, `HashSet`, `ConcurrentHashMap`ì˜ ì¸ìŠ¤í„´ìŠ¤, ë°°ì—´, int ë²”ìœ„, long ë²”ìœ„

### **âœ”ï¸ ë³‘ë ¬í™” íš¨ê³¼ê°€ ì¢‹ì€ ìë£Œêµ¬ì¡°ì˜ ê³µí†µì **

1. ì •í™•í•˜ê³  ì‰½ê²Œ ë‚˜ëˆŒ ìˆ˜ ìˆë‹¤.
   1. **ë°ì´í„°ë¥¼ ì›í•˜ëŠ” í¬ê¸°ë¡œ ì •í™•í•˜ê³  ì‰½ê²Œ ë‚˜ëˆŒìˆ˜ ìˆë‹¤.**
   2. ë”°ë¼ì„œ ë‹¤ìˆ˜ì˜ ìŠ¤ë ˆë“œì— ë¶„ë°°í•˜ê¸° ì¢‹ë‹¤.
   3. ë‚˜ëˆ„ëŠ” ì‘ì—…ì€ **Spliterator**ê°€ ë‹´ë‹¹í•˜ë©°, Streamì´ë‚˜ Iterableì˜ spliterator ë©”ì„œë“œë¡œ ì–»ëŠ”ë‹¤.
2. ì°¸ì¡° ì§€ì—­ì„±ì´ ë›°ì–´ë‚˜ë‹¤.
   1. ì´ì›ƒí•œ ì›ì†Œì˜ ì°¸ì¡°ë“¤ì´ ë©”ëª¨ë¦¬ì— ì—°ì†í•´ì„œ ì €ì¥ë˜ì–´ ìˆë‹¤.
   2. ë‹¤ëŸ‰ì˜ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë²Œí¬ ì—°ì‚°ì„ ë³‘ë ¬í™” í•  ë•Œ ìœ ë¦¬í•˜ë‹¤.
   > ì°¸ì¡° ì§€ì—­ì„±ì´ ê°€ì¥ ë›°ì–´ë‚œ ìë£Œêµ¬ì¡°ëŠ” ê¸°ë³¸ íƒ€ì… ë°°ì—´ì´ë‹¤. ê¸°ë³¸ íƒ€ì… ë°°ì—´ì€ ë°ì´í„° ìì²´ê°€ ë©”ëª¨ë¦¬ì— ì—°ì†ì ìœ¼ë¡œ ì €ì¥ë˜ê¸° ë•Œë¬¸ì´ë‹¤.

## **ì¢…ë‹¨ ì—°ì‚°ê³¼ ë³‘ë ¬í™”**

ìŠ¤íŠ¸ë¦¼ íŒŒì´í”„ë¼ì¸ì˜ ì¢…ë‹¨ ì—°ì‚°ì˜ ë™ì‘ ë°©ì‹ ì—­ì‹œ ë³‘ë ¬ ìˆ˜í–‰ íš¨ìœ¨ì— ì˜í–¥ì„ ì¤€ë‹¤.

### **ë³‘ë ¬í™”ì— ì í•©í•œ ì¢…ë‹¨ ì—°ì‚° â­•**

- ì¶•ì†Œ ì¢…ë‹¨ ì—°ì‚°(íŒŒì´í”„ë¼ì¸ì—ì„œ ë§Œë“¤ì–´ì§„ ëª¨ë“  ì›ì†Œë¥¼ í•˜ë‚˜ë¡œ í•©ì¹˜ëŠ” ì‘ì—…)
- Streamì˜ `reduce` ë©”ì„œë“œ ì¤‘ í•˜ë‚˜, í˜¹ì€ `min`, `max`, `count`, `sum`
- `anyMatch`, `allMatch`, `noneMatch` - ì¡°ê±´ì— ë§ìœ¼ë©´ ë°”ë¡œ ë°˜í™˜ë˜ëŠ” ë©”ì„œë“œ

### **ë³‘ë ¬í™”ì— ì í•©í•˜ì§€ ì•Šì€ ì¢…ë‹¨ ì—°ì‚° âŒ**

- ê°€ë³€ ì¶•ì†Œ(mutable reduction)ë¥¼ ìˆ˜í–‰í•˜ëŠ” Streamì˜ `collect` ë©”ì„œë“œëŠ” ë³‘ë ¬í™”ì— ì í•©í•˜ì§€ ì•Šë‹¤.
- ì»¬ë ‰ì…˜ì„ í•©ì¹˜ëŠ” ë¶€ë‹´ì´ í¬ê¸° ë•Œë¬¸ì´ë‹¤.

## **ğŸ”‘ ë³‘ë ¬í™” ì˜¬ë°”ë¥´ê²Œ ì‚¬ìš©í•˜ê¸°**

### **ì•ˆì „ ì‹¤íŒ¨(safety failure)**

- ì•ˆì „ ì‹¤íŒ¨ë€, ìŠ¤íŠ¸ë¦¼ì„ ì˜ëª» ë³‘ë ¬í™” í–ˆì„ ë•Œ ì„±ëŠ¥ì´ ë‚˜ë¹ ì§ˆ ë¿ ì•„ë‹ˆë¼, ê²°ê³¼ ìì²´ê°€ ì˜ëª»ë˜ê±°ë‚˜ ì˜ˆìƒì¹˜ ëª»í•œ ë™ì‘ì´ ë°œìƒí•˜ëŠ” ê²ƒì„ ë§í•œë‹¤.
- ë³‘ë ¬í™”í•œ íŒŒì´í”„ë¼ì¸ì´ ì‚¬ìš©í•˜ëŠ” `mappers`, `filters`, í˜¹ì€ í”„ë¡œê·¸ë˜ë¨¸ê°€ ì œê³µí•œ ë‹¤ë¥¸ í•¨ìˆ˜ ê°ì²´ê°€ ëª…ì„¸ëŒ€ë¡œ ë™ì‘í•˜ì§€ ì•Šì„ ë•Œ ë²Œì–´ì§ˆ ìˆ˜ ìˆë‹¤.
- Stream ëª…ì„¸ëŠ” í•¨ìˆ˜ ê°ì²´ì— ê´€í•œ ì—„ì¤‘í•œ ê·œì•½ì„ ì •ì˜í•´ë†¨ë‹¤.

### **âœ”ï¸ Stream ëª…ì„¸ ê·œì•½**

- Streamì˜ reduce ì—°ì‚°ì— ê±´ë„¤ì§€ëŠ” ëˆ„ì ê¸°ì™€ ê²°í•©ê¸° í•¨ìˆ˜ëŠ” ë°˜ë“œì‹œ **ê²°í•© ë²•ì¹™**ì„ ë§Œì¡±í•´ì•¼ í•œë‹¤.

  ê²°í•© ë²•ì¹™ : (a op b) op c == a op (b op c)

- ê°„ì„­ë°›ì§€ ì•Šì•„ì•¼ í•œë‹¤. (non-intefering)

  **íŒŒì´í”„ë¼ì¸ì´ ìˆ˜í–‰ë˜ëŠ” ë™ì•ˆ ë°ì´í„° ì†ŒìŠ¤ê°€ ë³€ê²½ë˜ì§€ ì•Šì•„ì•¼ í•œë‹¤.**

- ìƒíƒœë¥¼ ê°–ì§€ ì•Šì•„ì•¼ í•œë‹¤. (stateless)

ì´ëŸ¬í•œ ìš”êµ¬ì‚¬í•­ì„ ì§€í‚¤ì§€ ëª»í•˜ëŠ” ìƒíƒœì—ì„œ ë³‘ë ¬ë¡œ íŒŒì´í”„ë¼ì¸ì„ ìˆ˜í–‰í•˜ë©´ ì‹¤íŒ¨ë¡œ ì´ì–´ì§€ê¸° ì‰½ë‹¤.

### ë³‘ë ¬í™”ë¥¼ ì‚¬ìš©í•  ê°€ì¹˜ê°€ ìˆëŠ”ì§€ íŒë‹¨í•˜ì

- ìŠ¤íŠ¸ë¦¼ ë³‘ë ¬í™”ëŠ” ì˜¤ì§ ì„±ëŠ¥ ìµœì í™” ìˆ˜ë‹¨ì„ì„ ê¸°ì–µí•˜ì.
- ë³€ê²½ ì „í›„ë¡œ ë°˜ë“œì‹œ ì„±ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•´ì„œ ë³‘ë ¬í™”ë¥¼ ì‚¬ìš©í•  ê°€ì¹˜ê°€ ìˆëŠ”ì§€ íŒë‹¨í•´ì•¼í•œë‹¤.

## **ë³‘ë ¬í™”ë¥¼ íš¨ê³¼ì ìœ¼ë¡œ ì‚¬ìš©í•œ ì˜ˆì œ**

ì¡°ê±´ì´ ì˜ ê°–ì¶°ì§€ë©´ `parallel` ë©”ì„œë“œ í˜¸ì¶œ í•˜ë‚˜ë¡œ êµ‰ì¥í•œ ì„±ëŠ¥ í–¥ìƒì„ ê¸°ëŒ€í•  ìˆ˜ ìˆë‹¤.

ì•„ë˜ ì˜ˆì œëŠ” ë³‘ë ¬í™” í•˜ê¸° ì¢‹ì€ ì¡°ê±´ì„ ê°–ì¶˜ ì†Œìˆ˜ ê³„ì‚° ìŠ¤íŠ¸ë¦¼ íŒŒì´í”„ë¼ì¸ ì½”ë“œì´ë‹¤.

në³´ë‹¤ ì‘ê±°ë‚˜ ê°™ì€ ì†Œìˆ˜ì˜ ê°œìˆ˜ë¥¼ ê³„ì‚°í•˜ëŠ” í•¨ìˆ˜

```java
public class PrimeCounting {

    // ì†Œìˆ˜ ê³„ì‚° ìŠ¤íŠ¸ë¦¼ íŒŒì´í”„ë¼ì¸
    static long pi(long n) {
        return LongStream.rangeClosed(2, n)
                .mapToObj(BigInteger::valueOf)
                .filter(i -> i.isProbablePrime(50))
                .count();
    }

    @Test
    void primeCountingTest() {
        System.out.println(pi(10_000_000));
    }
}
```
![primeCountingTest](image/primeCountingTest.png)

- 10^7 ê³„ì‚° ì‹œ, 30ì´ˆê°€ ê±¸ë ¸ë‹¤.

`parallel` ë©”ì„œë“œë¥¼ ì¶”ê°€í•´ì„œ ë³‘ë ¬í™” í•´ë³´ì

```java
public class PrimeCounting {

    // ë³‘ë ¬í™” ë²„ì „
    static long parallelPi(long n) {
        return LongStream.rangeClosed(2, n)
                .parallel()
                .mapToObj(BigInteger::valueOf)
                .filter(i -> i.isProbablePrime(50))
                .count();
    }

    @Test
    void parallelPrimeCountingTest() {
        System.out.println(parallelPi(10_000_000));
    }

}
```
![parallelPrimeCountingTest](image/parallelPrimeCountingTest.png)

- 10^7 ê³„ì‚° ì‹œ, 9.7ì´ˆê°€ ê±¸ë ¸ë‹¤.
- `parallel` í˜¸ì¶œì„ ì¶”ê°€í•œ ê²ƒë¿ì´ì§€ë§Œ, **ì‹œê°„ì´ 2ë°° ì´ìƒ ë‹¨ì¶•**ëë‹¤.

## **ë¬´ì‘ìœ„ ìˆ˜ë“¤ë¡œ ì´ë£¨ì–´ì§„ ìŠ¤íŠ¸ë¦¼ ë³‘ë ¬í™”**

- **`SplittableRandom` ì¸ìŠ¤í„´ìŠ¤ë¥¼ í™œìš©í•´ì„œ ë³‘ë ¬í™”í•˜ì.** ì„±ëŠ¥ì´ ì„ í˜•ìœ¼ë¡œ ì¢‹ì•„ì§„ë‹¤.
- Randomì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš° ë³‘ë ¬í™”ë¥¼ í•´ì„  ì•ˆëœë‹¤.

  ëª¨ë“  ì—°ì‚°ì„ ë™ê¸°í™”í•˜ê¸° ë•Œë¬¸ì— ìµœì•…ì˜ ì„±ëŠ¥ìœ¼ë¡œ ì´ì–´ì§„ë‹¤.

- ë¬´ì‘ìœ„ ìˆ˜ ë³‘ë ¬í™” ì—°ì‚° ì†ë„ (`SplittableRandom` > `ThreadLocalRandom` > `Random`)


## ğŸ’¡ **ì •ë¦¬**

- ê³„ì‚°ë„ ì •í™•í•˜ê³  ì„±ëŠ¥ë„ ì¢‹ì•„ì§ˆ ê±°ë¼ëŠ” í™•ì‹  ì—†ì´ëŠ” ìŠ¤íŠ¸ë¦¼ íŒŒì´í”„ë¼ì¸ ë³‘ë ¬í™”ë¥¼ í•˜ì§€ ë§ì.
- ìˆ˜ì • í›„ ì½”ë“œê°€ ì—¬ì „íˆ ì •í™•í•œì§€ í™•ì¸í•˜ê³  ë³‘ë ¬í™” ì‚¬ìš© ê°€ì¹˜ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ì.
- ìœ„ì˜ ì¡°ê±´ë“¤ì´ í™•ì‹¤í•´ì¡Œì„ ë•Œ, ë³‘ë ¬í™” ë²„ì „ ì½”ë“œë¥¼ ìš´ì˜ ì½”ë“œì— ë°˜ì˜í•˜ì.

## **ğŸ•¶ï¸ ì°¸ê³ **

https://www.baeldung.com/java-fork-join
